# Health Monitor

Полнофункциональное Android-приложение на Kotlin, которое собирает данные с BLE-датчика (пульс и давление), сохраняет их в Room, анализирует тренды и синхронизирует с сервером через Retrofit.

## Технологии

- Kotlin + Coroutines, Gradle Kotlin DSL, JVM target 17
- Jetpack Compose (Material3, Navigation)
- MVVM, ViewModel, StateFlow
- Room (через KSP) для локального хранения
- DataStore Preferences для настроек
- Retrofit + OkHttp + Moshi
- WorkManager для фоновой синхронизации
- BLE API (сканирование и подписка на характеристики 0x2A37, 0x2A35)
- MPAndroidChart внутри Compose через `AndroidView`

## Требования окружения

- Android Studio Ladybug или новее
- Android SDK 34
- Устройство или эмулятор с API 24+
- Для работы с BLE необходим реальный девайс с Bluetooth LE

## Сборка и запуск

```bash
./gradlew clean assembleDebug
./gradlew test
```

## Первичная настройка приложения

1. При первом запуске разрешите приложению доступ к Bluetooth и геолокации (для устройств < Android 12 требуется ACCESS_FINE_LOCATION для сканирования BLE).
2. Включите Bluetooth на устройстве.
3. Перейдите на экран **Настройки**:
   - Укажите **User ID** – он попадёт в каждую запись.
   - Введите **Base URL** вашего сервера (по умолчанию используется HTTPS `https://api.example.com/`).
   - При необходимости добавьте **Bearer Token** – он автоматически подставляется в заголовок `Authorization`.
   - Переключатель **Разрешить HTTP** разблокирует возможность использовать незащищённые HTTP-адреса. По умолчанию приложение запрещает такие запросы на уровне сетевой конфигурации и кода. При включении вы увидите предупреждение в Snackbar.
   - Включите **Demo Mode**, если у вас нет реального датчика – приложение начнёт генерировать синтетические данные каждые 5 секунд.

## Работа с BLE

1. На вкладке **Датчик** нажмите «Сканировать» – список устройств обновится в течение 15 секунд.
2. Выберите устройство из списка и нажмите «Старт измерений».
3. После подключения приложение подпишется на характеристики Heart Rate Measurement (0x2A37) и Blood Pressure Measurement (0x2A35), распарсит показания и сохранит их в базу.
4. Последнее значение отображается на карточке в реальном времени.

> Примечание: WorkManager по требованиям платформы запускает периодическую задачу минимум раз в 15 минут, хотя приложение запрашивает интервал 5 минут.

## История и аналитика

- Экран **История** позволяет выбрать период (24 часа, 7 или 30 дней), посмотреть список записей и график пульса.
- Кнопка «Обновить с сервера» запрашивает `/api/v1/history/{userId}?days=...` и кэширует результаты локально.
- Экран **Аналитика** строит простую линейную регрессию по последним 10 значениям пульса и показывает наклон с точностью до двух знаков. Если наклон > 0.5 – выводится предупреждение «Пульс растёт — возможная нагрузка или стресс».

## Сетевые настройки и безопасность

- Network Security Config (`res/xml/network_security_config.xml`) запрещает незашифрованный HTTP-трафик по умолчанию.
- Попытка использовать HTTP при выключенном флажке «Разрешить HTTP» приводит к исключению и предупреждению пользователю.

## Тесты

- `AnalyticsTest` проверяет корректность расчёта наклона тренда.

## Сценарии отладки

- **Demo Mode** – полезен в отсутствие реального датчика, все данные попадают в Room и участвуют в синхронизации.
- **Логи сети** – в сборке debug включён `HttpLoggingInterceptor`.

## Разрешения

Manifest включает полный набор разрешений для BLE и сети. В рантайме приложение запрашивает необходимые разрешения через Compose UI. Для Android 12+ используется `BLUETOOTH_SCAN` с флагом `neverForLocation`.

## WorkManager

Фоновая синхронизация (`SyncWorker`) берёт несинхронизированные записи из Room, отправляет их по одной (`POST /api/v1/measurements`) и в случае успеха помечает `isSynced = true`. Ошибки сети приводят к `Result.retry()`.

## Вопросы и поддержка

- Для интеграции с сервером замените URL и токен в настройках.
- При работе с реальным датчиком убедитесь, что характеристики поддерживают стандартные UUID Heart Rate и Blood Pressure.
- Для расширения используйте `HealthRepository` и `AppModule` в качестве базовых точек внедрения зависимостей.
